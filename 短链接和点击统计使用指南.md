# 🔗 短链接和点击统计功能使用指南

## ✅ 已实现功能

### 1. 短链接自动生成
- ✅ 注册分销商时自动生成短链接
- ✅ 短链接格式：`https://your-domain.com/r/REFERRAL_CODE`
- ✅ 例如：`https://ai-counselor-2025-11-3-v1.vercel.app/r/8536WLHN`

### 2. 智能重定向
- ✅ 访问短链接自动重定向到支付页面
- ✅ 重定向格式：`/payment?ref=REFERRAL_CODE`
- ✅ 自动验证推荐码有效性
- ✅ 推荐码无效时跳转到普通支付页面

### 3. 点击统计
- ✅ 自动记录每次点击的详细信息：
  - IP 地址
  - 用户代理（浏览器信息）
  - 来源页面（Referer）
  - 点击时间
- ✅ 实时更新分销商的总点击数
- ✅ 自动过滤无效点击

### 4. 数据展示

#### 管理后台（`/ad7m2in9/affiliates`）
- ✅ 显示每个分销商的总点击数
- ✅ 点击数列使用蓝色高亮显示
- ✅ 可按点击数排序

#### 分销商后台（`/affiliate`）
- ✅ 显示个人总点击数
- ✅ 显示转化率（订单数 / 点击数）
- ✅ 显示转化百分比

---

## 📋 数据库部署步骤

### 第一步：创建点击统计表

在 Supabase SQL Editor 中执行：

```sql
-- 1. 创建点击记录表
CREATE TABLE IF NOT EXISTS public.affiliate_clicks (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  affiliate_id UUID REFERENCES public.affiliates(id) ON DELETE CASCADE,
  referral_code TEXT NOT NULL,
  ip_address TEXT,
  user_agent TEXT,
  referer TEXT,
  clicked_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. 创建索引
CREATE INDEX IF NOT EXISTS idx_affiliate_clicks_affiliate_id ON public.affiliate_clicks(affiliate_id);
CREATE INDEX IF NOT EXISTS idx_affiliate_clicks_referral_code ON public.affiliate_clicks(referral_code);
CREATE INDEX IF NOT EXISTS idx_affiliate_clicks_clicked_at ON public.affiliate_clicks(clicked_at);

-- 3. 添加点击统计字段
ALTER TABLE public.affiliates
ADD COLUMN IF NOT EXISTS total_clicks INTEGER DEFAULT 0;

-- 4. 创建触发器函数
CREATE OR REPLACE FUNCTION update_affiliate_clicks()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE public.affiliates
  SET total_clicks = total_clicks + 1
  WHERE id = NEW.affiliate_id;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 5. 创建触发器
DROP TRIGGER IF EXISTS trigger_update_affiliate_clicks ON public.affiliate_clicks;
CREATE TRIGGER trigger_update_affiliate_clicks
AFTER INSERT ON public.affiliate_clicks
FOR EACH ROW
EXECUTE FUNCTION update_affiliate_clicks();
```

### 第二步：验证部署

```sql
-- 验证表结构
SELECT 
  column_name,
  data_type,
  is_nullable
FROM information_schema.columns
WHERE table_schema = 'public'
  AND table_name = 'affiliate_clicks'
ORDER BY ordinal_position;

-- 验证 affiliates 表有 total_clicks 字段
SELECT 
  column_name,
  data_type,
  column_default
FROM information_schema.columns
WHERE table_schema = 'public'
  AND table_name = 'affiliates'
  AND column_name = 'total_clicks';
```

---

## 🎯 使用示例

### 1. 分销商注册

注册成功后会看到：

```
Your Referral Code: 8536WLHN

Your Referral Link:
https://ai-counselor-2025-11-3-v1.vercel.app/r/8536WLHN

[Copy Button]
```

### 2. 分销商分享链接

- 复制短链接并分享给潜在客户
- 客户点击链接时：
  - 系统自动记录点击
  - 重定向到支付页面（带推荐码参数）
  - 客户支付后自动归属到分销商账户

### 3. 查看统计数据

#### 分销商后台示例：
```
Link Clicks: 156
12.8% conversion
（20 订单 / 156 点击）
```

#### 管理后台示例：
```
分销商         推荐码      点击数    订单数    转化率
Alice Zhang   8536WLHN    156       20        12.8%
Bob Li        7J9K2MNP    89        5         5.6%
```

---

## 🔧 技术实现细节

### 1. 短链接重定向流程

```
用户访问短链接
  ↓
/r/[code]/page.tsx 接收请求
  ↓
调用 /api/affiliate/track-click 记录点击
  ↓
验证推荐码有效性
  ↓
重定向到 /payment?ref=[code]
```

### 2. 点击统计触发器

- **触发时机**：每次插入 `affiliate_clicks` 记录
- **触发动作**：自动更新 `affiliates.total_clicks` +1
- **性能优化**：使用数据库触发器，无需额外 API 调用

### 3. 数据表关系

```
affiliates (分销商表)
  ├─ id (主键)
  ├─ referral_code (推荐码)
  └─ total_clicks (总点击数) ←─ 触发器自动更新

affiliate_clicks (点击记录表)
  ├─ id (主键)
  ├─ affiliate_id (外键 → affiliates.id)
  ├─ referral_code (推荐码)
  ├─ ip_address (IP地址)
  ├─ user_agent (浏览器信息)
  ├─ referer (来源页面)
  └─ clicked_at (点击时间)
```

---

## 🚀 部署后测试

### 1. 测试短链接重定向

```bash
# 在浏览器中访问
https://your-domain.com/r/WELCOME2025

# 应该自动跳转到
https://your-domain.com/payment?ref=WELCOME2025
```

### 2. 测试点击记录

```sql
-- 查看最新的点击记录
SELECT 
  ac.*,
  a.email,
  a.name
FROM public.affiliate_clicks ac
JOIN public.affiliates a ON a.id = ac.affiliate_id
ORDER BY ac.clicked_at DESC
LIMIT 10;
```

### 3. 测试点击计数

```sql
-- 验证总点击数是否正确
SELECT 
  a.referral_code,
  a.total_clicks AS stored_count,
  COUNT(ac.id) AS actual_count,
  (a.total_clicks = COUNT(ac.id)) AS is_correct
FROM public.affiliates a
LEFT JOIN public.affiliate_clicks ac ON ac.affiliate_id = a.id
GROUP BY a.id, a.referral_code, a.total_clicks;
```

---

## 📊 数据分析示例

### 查看转化率排行

```sql
SELECT 
  a.referral_code,
  a.name,
  a.email,
  a.total_clicks,
  COUNT(o.id) AS total_orders,
  CASE 
    WHEN a.total_clicks > 0 
    THEN ROUND((COUNT(o.id)::DECIMAL / a.total_clicks) * 100, 2)
    ELSE 0 
  END AS conversion_rate
FROM public.affiliates a
LEFT JOIN public.orders o ON o.affiliate_id = a.id AND o.status = 'completed'
WHERE a.status = 'active'
GROUP BY a.id, a.referral_code, a.name, a.email, a.total_clicks
ORDER BY conversion_rate DESC;
```

### 查看每日点击趋势

```sql
SELECT 
  DATE(clicked_at) AS click_date,
  COUNT(*) AS total_clicks,
  COUNT(DISTINCT affiliate_id) AS active_affiliates
FROM public.affiliate_clicks
WHERE clicked_at >= NOW() - INTERVAL '30 days'
GROUP BY DATE(clicked_at)
ORDER BY click_date DESC;
```

---

## ⚠️ 注意事项

### 1. 隐私保护
- IP 地址已记录，注意符合 GDPR 等隐私法规
- 建议定期清理旧的点击记录（如 90 天后）

### 2. 防刷机制
- 当前版本记录所有点击
- 建议后续添加防刷逻辑（如同一 IP 短时间内多次点击只计数一次）

### 3. 性能优化
- 使用了数据库索引加速查询
- 使用了触发器减少 API 调用
- 大量点击时性能良好

---

## 🎉 功能优势

1. **简洁易记**：短链接比长链接更容易分享
2. **实时统计**：点击数实时更新，无延迟
3. **详细分析**：记录 IP、浏览器、来源等详细信息
4. **自动归属**：客户通过短链接购买，自动归属到分销商
5. **转化追踪**：可以看到每个分销商的转化率

---

## 📝 后续可扩展功能

- [ ] 防刷机制（同一 IP 短时间内多次点击去重）
- [ ] 自定义短链接（分销商可自定义推荐码）
- [ ] 点击来源分析（按国家、设备、浏览器分类）
- [ ] A/B 测试支持（不同分销商看到不同落地页）
- [ ] 二维码生成（扫码直达推荐链接）

---

**部署完成后，短链接和点击统计功能将自动生效！**

