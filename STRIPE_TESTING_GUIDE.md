# 🧪 Stripe 支付测试指南

## ✅ 已完成的配置

1. ✅ 添加 Stripe API 密钥到 `.env.local`
2. ✅ 修复认证逻辑（从 Supabase 改为自定义 Google OAuth 会话）
3. ✅ 创建 Webhook 处理器 (`/api/webhooks/stripe`)
4. ✅ 创建支付成功页面 (`/purchase-success`)
5. ✅ 创建购买验证 API (`/api/verify-purchase`)

---

## 🚀 测试本地支付流程

### 步骤 1：重启开发服务器

因为我们添加了新的环境变量，需要重启服务器：

```bash
# 停止当前服务器 (Ctrl + C)
# 然后重新启动
npm run dev
```

### 步骤 2：测试支付流程

1. **访问应用**：http://localhost:3000

2. **确认已登录**：
   - 右上角应显示您的 Google 账户信息
   - 如果未登录，先使用 Google 登录

3. **进入支付页面**：
   - 点击右上角头像 → "View Account"
   - 或直接访问：http://localhost:3000/payment

4. **选择套餐**：
   - 选择任意一个套餐（建议先选 $9.99 的 1 小时套餐测试）
   - 点击 "Purchase Now"

5. **Stripe 测试支付**：
   - 应该会跳转到 Stripe 支付页面
   - 使用以下测试卡信息：
     - **卡号**：`4242 4242 4242 4242`
     - **有效期**：任何未来日期（如 `12/34`）
     - **CVC**：任意 3 位数字（如 `123`）
     - **邮编**：任意 5 位数字（如 `12345`）
     - **姓名**：任意名字

6. **完成支付**：
   - 点击 "Pay"
   - 应该会自动返回到成功页面
   - 显示购买详情和已添加的时间

7. **验证时间充值**：
   - 返回首页或点击 "View Account"
   - 确认 "Available Consultation Time" 已更新

---

## 🔍 故障排查

### 问题 1：点击 "Purchase Now" 后没有反应

**可能原因：**
- 未登录或会话过期

**解决方案：**
1. 按 F12 打开开发者工具
2. 查看 Console 标签中的错误
3. 如果看到 "Unauthorized"，请重新登录

### 问题 2：无法跳转到 Stripe 支付页面

**可能原因：**
- Stripe API 密钥未正确配置
- 服务器未重启

**解决方案：**
1. 确认 `.env.local` 中有 `STRIPE_SECRET_KEY`
2. 重启开发服务器（`npm run dev`）
3. 查看服务器日志中的错误信息

### 问题 3：支付成功但时间未更新

**可能原因：**
- 前端代码未正确更新 localStorage

**解决方案：**
1. 刷新页面
2. 查看浏览器 Console 中的日志
3. 手动检查 localStorage（F12 → Application → Local Storage）

---

## 📊 测试用的 Stripe 卡号

| 卡号 | 结果 | 用途 |
|------|------|------|
| `4242 4242 4242 4242` | ✅ 成功 | 测试正常支付 |
| `4000 0000 0000 0002` | ❌ 失败 | 测试支付被拒绝 |
| `4000 0000 0000 9995` | ⚠️ 余额不足 | 测试余额不足 |
| `4000 0000 0000 0069` | ⏱️ 过期 | 测试卡过期 |
| `4000 0000 0000 0127` | 🔒 CVC 错误 | 测试 CVC 验证失败 |

---

## 🎯 本地测试清单

测试完成后，请确认：

- [ ] 能够访问支付页面 (`/payment`)
- [ ] 能够选择套餐并点击购买
- [ ] 成功跳转到 Stripe 支付页面
- [ ] 使用测试卡 `4242 4242 4242 4242` 完成支付
- [ ] 支付成功后返回到 `/purchase-success` 页面
- [ ] 成功页面显示正确的购买详情
- [ ] 返回首页后，可用时间已更新
- [ ] 刷新页面后，时间仍然正确显示

---

## 🚀 准备部署到 Vercel

本地测试成功后，下一步是部署到 Vercel。

### 需要做的事情：

1. **提交代码到 GitHub**
2. **配置 Vercel 环境变量**
3. **配置 Stripe Webhook**
4. **测试生产环境**

---

## 💡 提示

### 关于 Webhook

⚠️ **本地测试时，Stripe Webhook 无法工作**，因为 Stripe 无法访问您的 `localhost:3000`。

这意味着：
- ✅ 支付流程可以测试
- ✅ 购买记录可以验证
- ❌ Webhook 通知无法在本地接收

要测试 Webhook，您需要：
1. 部署到 Vercel（Stripe 可以访问）
2. 或使用 Stripe CLI（本地转发 Webhook）

**我建议直接部署到 Vercel 进行完整测试！**

---

准备好测试了吗？🧪

1. 重启开发服务器
2. 访问 http://localhost:3000
3. 尝试购买 1 小时套餐
4. 告诉我结果！

测试成功后，我们就可以部署到 Vercel 了！🚀

